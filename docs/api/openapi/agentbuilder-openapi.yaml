openapi: 3.0.3
info:
  title: AgentBuilder API
  version: 1.0.0
  description: |
    AgentBuilder orchestrates the creation of complete AI agents by coordinating 
    KnowledgeBuilder and SkillBuilder services. It provides a unified interface for 
    agent lifecycle management including creation, retrieval, updating, and deletion.
    
    ## Key Features
    - **Agent Orchestration**: Coordinates knowledge and skill generation
    - **Lifecycle Management**: Full CRUD operations for agent resources
    - **Capability Aggregation**: Combines knowledge clouds and skill sets
    - **Deepening Cycles**: Supports iterative knowledge refinement (0-11 cycles)
    
    ## Service Dependencies
    - KnowledgeBuilder (Port 5002) - Knowledge cloud generation
    - SkillBuilder (Port 5001) - Skill set generation
    
  contact:
    name: Chrysalis API Support
    url: https://docs.chrysalis.dev
    email: support@chrysalis.dev
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:5000
    description: Development server
  - url: https://api.chrysalis.dev
    description: Production server

tags:
  - name: Health
    description: Service health check endpoints
  - name: Agents
    description: Agent creation and management operations

security:
  - bearerAuth: []

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns service health status and basic service information
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          status:
                            type: string
                            enum: [healthy, degraded, unhealthy]
                            example: healthy
                          service:
                            type: string
                            example: agentbuilder
                          version:
                            type: string
                            example: v1

  /api/v1/agents:
    post:
      tags:
        - Agents
      summary: Create new agent
      description: |
        Creates a complete agent by orchestrating KnowledgeBuilder and SkillBuilder services.
        
        **Process Flow:**
        1. Validates request parameters
        2. Calls KnowledgeBuilder to generate knowledge cloud
        3. Aggregates knowledge into corpus text
        4. Calls SkillBuilder to generate skills from corpus
        5. Stores and returns complete agent
        
        **Rate Limits:** 10 requests per minute per API key
      operationId: createAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentCreateRequest'
            examples:
              basic:
                summary: Basic agent creation
                value:
                  agent_id: agent-bob-ross-001
                  role_model:
                    name: Bob Ross
                    occupation: Artist
                  deepening_cycles: 3
      responses:
        '201':
          description: Agent created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Agent'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/ValidationError'
        '502':
          $ref: '#/components/responses/UpstreamError'
    
    get:
      tags:
        - Agents
      summary: List agents
      description: |
        Retrieves a paginated list of agents with optional filtering and sorting.
        
        **Rate Limits:** 100 requests per minute per API key
      operationId: listAgents
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
        - $ref: '#/components/parameters/SortParam'
        - name: filter[status]
          in: query
          description: Filter by agent status
          schema:
            type: string
            enum: [completed, pending, failed]
      responses:
        '200':
          description: List of agents retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Agent'
                      meta:
                        allOf:
                          - $ref: '#/components/schemas/ResponseMeta'
                          - type: object
                            properties:
                              pagination:
                                $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/v1/agents/{agent_id}:
    get:
      tags:
        - Agents
      summary: Get agent by ID
      description: Retrieves detailed information about a specific agent
      operationId: getAgent
      parameters:
        - $ref: '#/components/parameters/AgentIdParam'
      responses:
        '200':
          description: Agent retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Agent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    patch:
      tags:
        - Agents
      summary: Partially update agent
      description: |
        Updates specific fields of an existing agent without replacing the entire resource.
        Only provided fields will be updated.
      operationId: updateAgent
      parameters:
        - $ref: '#/components/parameters/AgentIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentUpdateRequest'
      responses:
        '200':
          description: Agent updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Agent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
    
    put:
      tags:
        - Agents
      summary: Replace agent
      description: |
        Completely replaces an existing agent with new data.
        All required fields must be provided.
      operationId: replaceAgent
      parameters:
        - $ref: '#/components/parameters/AgentIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentReplaceRequest'
      responses:
        '200':
          description: Agent replaced successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Agent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'
    
    delete:
      tags:
        - Agents
      summary: Delete agent
      description: Permanently deletes an agent and all associated data
      operationId: deleteAgent
      parameters:
        - $ref: '#/components/parameters/AgentIdParam'
      responses:
        '200':
          description: Agent deleted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          deleted:
                            type: boolean
                            example: true
                          agent_id:
                            type: string
                            example: agent-bob-ross-001
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/agents/{agent_id}/capabilities:
    get:
      tags:
        - Agents
      summary: Get agent capabilities
      description: Retrieves the skills and knowledge associated with an agent
      operationId: getAgentCapabilities
      parameters:
        - $ref: '#/components/parameters/AgentIdParam'
      responses:
        '200':
          description: Capabilities retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          skills:
                            type: array
                            items:
                              $ref: '#/components/schemas/Skill'
                          knowledge:
                            type: array
                            items:
                              $ref: '#/components/schemas/KnowledgeItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/agents/{agent_id}/build:
    post:
      tags:
        - Agents
      summary: Rebuild agent
      description: Regenerates knowledge and skills for an existing agent
      operationId: rebuildAgent
      parameters:
        - $ref: '#/components/parameters/AgentIdParam'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                deepening_cycles:
                  type: integer
                  minimum: 0
                  maximum: 11
                  description: Number of knowledge deepening iterations
      responses:
        '200':
          description: Agent rebuilt successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Agent'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /build:
    post:
      tags:
        - Agents
      summary: Legacy create endpoint (deprecated)
      description: |
        **⚠️ DEPRECATED**: Use POST /api/v1/agents instead.
        
        This endpoint will be removed in v2.0.
      operationId: legacyCreateAgent
      deprecated: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agentId
                - roleModel
              properties:
                agentId:
                  type: string
                roleModel:
                  type: object
                  properties:
                    name:
                      type: string
                    occupation:
                      type: string
                deepeningCycles:
                  type: integer
      responses:
        '201':
          description: Agent created (with deprecation warning)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/APIResponse'
                  - type: object
                    properties:
                      meta:
                        allOf:
                          - $ref: '#/components/schemas/ResponseMeta'
                          - type: object
                            properties:
                              deprecated:
                                type: boolean
                                example: true
                              deprecation_notice:
                                type: string
                                example: Use POST /api/v1/agents instead

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication using API keys or JWT tokens.
        
        **Format:** `Authorization: Bearer <token>`
        
        **API Key Format:** `<keyId>.<secret>`

  parameters:
    AgentIdParam:
      name: agent_id
      in: path
      required: true
      description: Unique agent identifier
      schema:
        type: string
        minLength: 1
        maxLength: 100
        example: agent-bob-ross-001
    
    PageParam:
      name: page
      in: query
      description: Page number for pagination (1-indexed)
      schema:
        type: integer
        minimum: 1
        default: 1
    
    PerPageParam:
      name: per_page
      in: query
      description: Number of items per page (max 100)
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    
    SortParam:
      name: sort
      in: query
      description: |
        Comma-separated list of fields to sort by.
        Prefix with `-` for descending order.
      schema:
        type: string
        example: -created_at

  schemas:
    # Request Schemas
    AgentCreateRequest:
      type: object
      required:
        - agent_id
        - role_model
      properties:
        agent_id:
          type: string
          minLength: 1
          maxLength: 100
          description: Unique identifier for the agent
          example: agent-bob-ross-001
        role_model:
          $ref: '#/components/schemas/RoleModel'
        deepening_cycles:
          type: integer
          minimum: 0
          maximum: 11
          default: 0
          description: Number of knowledge deepening iterations
          example: 3
    
    AgentUpdateRequest:
      type: object
      minProperties: 1
      properties:
        role_model:
          type: object
          description: Partial role model updates
          additionalProperties: true
        deepening_cycles:
          type: integer
          minimum: 0
          maximum: 11
    
    AgentReplaceRequest:
      type: object
      required:
        - role_model
      properties:
        role_model:
          $ref: '#/components/schemas/RoleModel'
        deepening_cycles:
          type: integer
          minimum: 0
          maximum: 11
          default: 0
    
    RoleModel:
      type: object
      required:
        - name
        - occupation
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Name of the role model
          example: Bob Ross
        occupation:
          type: string
          minLength: 1
          maxLength: 200
          description: Occupation or profession
          example: Artist
      additionalProperties: true
    
    # Response Schemas
    APIResponse:
      type: object
      required:
        - success
        - meta
      properties:
        success:
          type: boolean
          description: Indicates if the request was successful
        data:
          description: Response data (present on success)
        error:
          $ref: '#/components/schemas/APIError'
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    
    Agent:
      type: object
      properties:
        agent_id:
          type: string
          example: agent-bob-ross-001
        role_model:
          $ref: '#/components/schemas/RoleModel'
        generated_skills:
          type: array
          items:
            $ref: '#/components/schemas/Skill'
        generated_knowledge:
          type: array
          items:
            $ref: '#/components/schemas/KnowledgeItem'
        status:
          type: string
          enum: [completed, pending, failed]
          example: completed
        created_at:
          type: string
          format: date-time
          example: '2026-01-11T04:00:00.000Z'
        updated_at:
          type: string
          format: date-time
          example: '2026-01-11T04:00:00.000Z'
    
    Skill:
      type: object
      properties:
        skill_id:
          type: string
          example: skill-001
        name:
          type: string
          example: Color Theory
        description:
          type: string
          example: Understanding of color relationships
        category:
          type: string
          example: Technical
    
    KnowledgeItem:
      type: object
      properties:
        knowledge_id:
          type: string
          example: knowledge-001
        entity:
          type: object
          properties:
            text:
              type: string
            type:
              type: string
        source:
          type: string
          example: Wikipedia
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          example: 0.95
    
    # Error Schemas
    APIError:
      type: object
      required:
        - code
        - message
        - category
        - timestamp
      properties:
        code:
          type: string
          example: VALIDATION_ERROR.REQUIRED_FIELD
        message:
          type: string
          example: Field 'agent_id' is required
        category:
          type: string
          enum:
            - VALIDATION_ERROR
            - AUTHENTICATION_ERROR
            - AUTHORIZATION_ERROR
            - NOT_FOUND_ERROR
            - CONFLICT_ERROR
            - RATE_LIMIT_ERROR
            - SERVICE_ERROR
            - UPSTREAM_ERROR
        details:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
        request_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        documentation_url:
          type: string
          format: uri
        retry_after:
          type: integer
        suggestions:
          type: array
          items:
            type: string
    
    ErrorDetail:
      type: object
      properties:
        field:
          type: string
        code:
          type: string
        message:
          type: string
        path:
          type: array
          items:
            type: string
    
    # Metadata Schemas
    ResponseMeta:
      type: object
      required:
        - request_id
        - timestamp
        - version
      properties:
        request_id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: v1
        deprecated:
          type: boolean
        deprecation_notice:
          type: string
    
    PaginationMeta:
      type: object
      required:
        - page
        - per_page
        - total
        - total_pages
        - has_next
        - has_prev
      properties:
        page:
          type: integer
          minimum: 1
        per_page:
          type: integer
          minimum: 1
          maximum: 100
        total:
          type: integer
          minimum: 0
        total_pages:
          type: integer
          minimum: 0
        has_next:
          type: boolean
        has_prev:
          type: boolean

  responses:
    BadRequest:
      description: Bad request - Invalid request format
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIResponse'
    
    Unauthorized:
      description: Unauthorized - Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIResponse'
    
    NotFound:
      description: Not found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIResponse'
    
    Conflict:
      description: Conflict - Resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIResponse'
    
    ValidationError:
      description: Validation error - Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIResponse'
    
    UpstreamError:
      description: Upstream service error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/APIResponse'
