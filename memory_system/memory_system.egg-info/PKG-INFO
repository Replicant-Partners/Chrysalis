Metadata-Version: 2.4
Name: memory-system
Version: 1.0.0
Summary: Chrysalis semantic memory services (beads, Fireproof, graph, embeddings)
Author: Chrysalis Team
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: cryptography>=41.0.0
Provides-Extra: dev
Requires-Dist: aiohttp>=3.9.0; extra == "dev"
Requires-Dist: pydantic>=2.0.0; extra == "dev"
Requires-Dist: pytest>=7.0.0; extra == "dev"

# Memory System - Semantic Services Package

**Last Updated**: January 13, 2026
**Version**: 3.3.0
**Tests**: 9 fusion/Zep/beads tests + Fireproof integration tests

Consolidated semantic processing, graph operations, and knowledge management utilities for Chrysalis.

---

## Overview

The Memory System package provides production-ready modules for semantic analysis, knowledge graphs, document processing, and embedding management.

```mermaid
flowchart LR
    subgraph Core["Core Modules"]
        BEADS[beads.py]
        CORE[core.py]
        STORES[stores.py]
    end
    
    subgraph Semantic["Semantic Processing"]
        SEM[semantic/]
        CONV[converters/]
        EMB[embedding/]
    end
    
    subgraph Distributed["Distributed Patterns"]
        CRDT[crdt_merge.py]
        GOSSIP[gossip.py]
        BYZ[byzantine.py]
    end
    
    subgraph Integration["Integration"]
        HOOKS[hooks/]
        GRAPH[graph/]
        BRIDGE[bridge_schema.py]
    end
    
    Core --> Semantic
    Semantic --> Integration
    Distributed --> Integration
```

---

## Installation

```bash
pip install -e memory_system/
```

---

## Quick Start

```python
from memory_system import create_embedding_service, create_graph_store

# Create embedding service (auto-detects provider)
embedding = create_embedding_service()

# Create graph store
graph = create_graph_store("sqlite", db_path="knowledge.db")
```

---

## Module Reference

### Fireproof (Hybrid Memory Layer) - NEW

Local-first, CRDT-based durable document store bridging short-term (Beads) and long-term (Zep) memory.

```python
from memory_system.fireproof import FireproofService, FireproofConfig

# Initialize with testing config (in-memory)
config = FireproofConfig.for_testing()
fireproof = FireproofService(config=config)
await fireproof.initialize()

# Store documents
doc_id = await fireproof.put({"type": "bead", "content": "Important context"})

# Query documents
beads = await fireproof.query_beads(limit=10, min_importance=0.7)

# Metadata capture for LLM observability
from memory_system.fireproof import PromptMetadataCapture

capture = PromptMetadataCapture(fireproof)
async with capture.capture_async(session_id="sess-1", model="claude-3") as meta:
    # ... LLM call ...
    meta.tokens_out = 150
    meta.score = 4.5
```

**Feature Flags** (environment variables):
- `FIREPROOF_ENABLED` - Master enable switch
- `FIREPROOF_SYNC_ENABLED` - Enable background sync to Zep
- `FIREPROOF_PROMOTION_ENABLED` - Enable bead promotion
- `FIREPROOF_METADATA_CAPTURE` - Enable LLM metadata capture
- `FIREPROOF_LOCAL_VECTORS` - Enable local vector caching

See [`docs/FIREPROOF_INTEGRATION_PROPOSAL.md`](../docs/FIREPROOF_INTEGRATION_PROPOSAL.md) for architecture details.

### Beads (Short-term Memory)

Append-only context chain for ephemeral memory with optional retention (max_items, ttl), blob offload, and Fireproof promotion hooks.

```python
from memory_system.beads import BeadsService
from memory_system.fireproof import FireproofService
from memory_system.fireproof.hooks import BeadPromotionHook

# Basic usage
beads = BeadsService(path=":memory:", max_items=100, ttl_seconds=3600)

# With Fireproof promotion (high-importance beads persisted beyond TTL)
fireproof = FireproofService(config=FireproofConfig.for_testing())
await fireproof.initialize()
hook = BeadPromotionHook(fireproof, threshold=0.7)

beads = BeadsService(
    path=":memory:",
    promotion_hook=hook.promote,
    promotion_threshold=0.7,
)

# Append (auto-promotes if importance >= 0.7)
bead_id = beads.append("conversation turn", role="assistant", importance=0.9)

# Fetch recent
recent = beads.recent(limit=10)
```

### Embedding Service (Nomic-first)

Multi-provider embedding with automatic fallback (Nomic → OpenAI → Deterministic).

```python
from shared.embedding import EmbeddingService

service = EmbeddingService()  # defaults: Nomic primary, OpenAI fallback, deterministic last
vec = service.embed("Knowledge representation")
```

**Environment Variables**:
- `NOMIC_API_KEY` (primary)
- `OPENAI_API_KEY` (fallback)
- `EMBEDDING_PROVIDER` to force provider (e.g., deterministic for offline tests)

### Graph Store + Zep KG

NetworkX/SQLite for local graphs; Zep for managed KG.

```python
from memory_system.graph import GraphStore
from memory_system.hooks import ZepHooks

# Local
graph = GraphStore(backend="sqlite", path="knowledge.db")

# Remote KG via Zep
zep = ZepHooks(endpoint="https://zep.example.com", api_key="...", project="default")
zep.on_store_kg(nodes=[{"id": "Python", "type": "lang"}], edges=[{"source": "Django", "target": "Python", "type": "built_with"}])
kg = zep.on_retrieve_kg(node_ids=["Python"], hops=2)
```

### Semantic Decomposition

Intent detection and triple extraction.

```python
from memory_system.semantic import HeuristicStrategy, AnthropicStrategy

# Pattern-based (no API required)
strategy = HeuristicStrategy()
frame = await strategy.decompose("fix the login bug in auth.py")
print(frame.intent)  # Intent.DEBUG

# LLM-powered (requires ANTHROPIC_API_KEY)
strategy = AnthropicStrategy()
frame = await strategy.decompose("create user authentication")
```

### CRDT Merge

Conflict-free replicated data types for distributed state.

```python
from memory_system.crdt_merge import ORSet, LWWRegister, MemoryCRDTMerger

# OR-Set for skills
skills = ORSet()
skills.add("python", tag="instance_1")
skills.add("typescript", tag="instance_2")

# LWW-Register for knowledge
knowledge = LWWRegister()
knowledge.set("fact_1", timestamp=1234567890, writer="instance_1")
```

### Byzantine Validation

Byzantine-resistant aggregation for multi-instance consensus.

```python
from memory_system.byzantine import ByzantineMemoryValidator, SupermajorityChecker

# Validate memory across instances
validator = ByzantineMemoryValidator()
result = validator.validate_memory(votes, threshold=0.67)

# Check supermajority
checker = SupermajorityChecker()
has_consensus = checker.has_supermajority(votes, total_instances=5)
```

### Gossip Protocol

Epidemic spreading for experience propagation.

```python
from memory_system.gossip import MemoryGossipProtocol, GossipConfig

config = GossipConfig(fanout=3, interval_ms=1000)
protocol = MemoryGossipProtocol(config)
protocol.add_peer(peer)
await protocol.gossip_memory(memory)
```

---

## Architecture

### Design Principles

1. **Modularity** - Each module is independent and testable
2. **Graceful Degradation** - Fallback strategies when APIs unavailable
3. **Zero Dependencies for Core** - Core functionality works offline
4. **Type Safety** - Full type hints with Pydantic validation

### Provider Fallback Chain

```
┌─────────────┐
│   Voyage    │ ← Primary (VOYAGE_API_KEY)
└──────┬──────┘
       │ failure/missing
       ↓
┌─────────────┐
│   OpenAI    │ ← Fallback (OPENAI_API_KEY)
└──────┬──────┘
       │ failure/missing
       ↓
┌─────────────┐
│   Ollama    │ ← Local (localhost:11434)
└──────┬──────┘
       │ failure/missing
       ↓
┌─────────────┐
│Deterministic│ ← Always available (hash-based)
└─────────────┘
```

---

## Testing

```bash
cd memory_system
python3 -m pytest tests/ -v

# Run Fireproof tests specifically
python3 -m pytest fireproof/tests/ -v
```

**Test Results**: 9 core tests + Fireproof integration tests

| Test File | Tests | Status |
|-----------|-------|--------|
| `test_beads.py` | 3 | ✅ |
| `test_zep_client.py` | 4 | ✅ |
| `test_fusion.py` | 2 | ✅ |
| `fireproof/tests/test_fireproof.py` | 25+ | ✅ |

```bash
# Run all memory system tests
pytest memory_system/tests/ memory_system/fireproof/tests/ -v
```

---

## Directory Structure

```
memory_system/
├── __init__.py          # Package exports
├── beads.py             # Short-term context chain (+ Fireproof promotion)
├── bridge_schema.py     # TypeScript bridge types
├── byzantine.py         # Byzantine validation
├── chrysalis_memory.py  # High-level memory API
├── chrysalis_types.py   # Core type definitions
├── core.py              # Memory primitives
├── crdt_merge.py        # CRDT implementations
├── embeddings.py        # Legacy embedding interface
├── fusion.py            # Retrieval fusion (+ Fireproof tier)
├── gossip.py            # Gossip protocol
├── identity.py          # Memory identity/signing
├── retrieval.py         # Retrieval engine
├── sanitization.py      # Input sanitization
├── stores.py            # Memory stores
├── threshold.py         # Threshold cryptography
│
├── analysis/            # Shannon entropy analysis
├── converters/          # Document/code converters
├── embedding/           # Multi-provider embeddings
├── fireproof/           # NEW: Local-first CRDT document store
│   ├── __init__.py      # Module exports
│   ├── config.py        # Configuration with feature flags
│   ├── hooks.py         # Promotion and metadata capture hooks
│   ├── schemas.py       # Document type definitions
│   ├── service.py       # FireproofService implementation
│   ├── sync.py          # Zep synchronization adapter
│   └── tests/           # Fireproof test suite
├── graph/               # Knowledge graph stores
├── hooks/               # Integration hooks (Zep)
├── lsp/                 # LSP adapters
├── resolvers/           # Entity resolvers
├── semantic/            # Semantic decomposition
└── tests/               # Core test suite
```

---

## Environment Variables

### Embedding & LLM

| Variable | Purpose | Default |
|----------|---------|---------|
| `VOYAGE_API_KEY` | Voyage embeddings | - |
| `OPENAI_API_KEY` | OpenAI embeddings | - |
| `ANTHROPIC_API_KEY` | Claude decomposition | - |
| `EMBEDDING_PROVIDER` | Force provider | auto |

### Fireproof (NEW)

| Variable | Purpose | Default |
|----------|---------|---------|
| `FIREPROOF_ENABLED` | Master enable switch | `false` |
| `FIREPROOF_DB_NAME` | Database name | `chrysalis-memory` |
| `FIREPROOF_DB_PATH` | SQLite path | `:memory:` |
| `FIREPROOF_SYNC_ENABLED` | Enable Zep sync | `false` |
| `FIREPROOF_SYNC_GATEWAY` | Sync gateway URL | - |
| `FIREPROOF_SYNC_INTERVAL` | Sync interval (seconds) | `60` |
| `FIREPROOF_PROMOTION_ENABLED` | Enable bead promotion | `false` |
| `FIREPROOF_PROMOTION_THRESHOLD` | Min importance for promotion | `0.7` |
| `FIREPROOF_METADATA_CAPTURE` | Enable LLM metadata capture | `false` |
| `FIREPROOF_LOCAL_VECTORS` | Enable local vector cache | `false` |
| `FIREPROOF_ENCRYPTION` | Enable encryption | `false` |

---

## Integration with TypeScript

The memory system bridges to TypeScript via:

- `bridge_schema.py` - Shared data structures
- `hooks/zep.py` - Zep integration stubs
- `embedding/service.py` - HTTP-callable embedding API

See `docs/AGENTIC_MEMORY_DESIGN.md` for full integration architecture.

---

## Related Documentation

| Document | Purpose |
|----------|---------|
| [Status](../docs/STATUS.md) | Implementation status |
| [Architecture](../ARCHITECTURE.md) | System design |
| [Memory Design](../docs/AGENTIC_MEMORY_DESIGN.md) | Memory architecture |
| [Fireproof Integration](../docs/FIREPROOF_INTEGRATION_PROPOSAL.md) | Fireproof architecture proposal |

---

**Maintainer**: Chrysalis Team
**License**: MIT (see repository LICENSE)
